<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Society Management Firebase Sync</title>
<style>
  :root {
    --main: #000;
    --bg: #fff;
    --accent: #0077cc;
    --border: #ccc;
    --meeting: #e0f7fa;
    --party: #fce4ec;
    --children: #f3e5f5;
    --problem: #fff3e0;
    --retirement: #e8f5e9;
    --birthday: #ede7f6;
    --parking: #f9fbe7;
  }
  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: 'Segoe UI', sans-serif;
    background: var(--bg);
    color: var(--main);
  }
  header {
    background: var(--main);
    color: var(--bg);
    text-align: center;
    padding: 1em;
    font-size: 1.5em;
  }
  .section {
    max-width: 800px;
    margin: auto;
    padding: 1em;
  }
  input, select, textarea, button {
    width: 100%;
    padding: 0.7em;
    margin: 0.5em 0;
    border: 1px solid var(--border);
    border-radius: 6px;
  }
  button {
    background: var(--main);
    color: white;
    cursor: pointer;
  }
  .card {
    padding: 1em;
    margin: 1em 0;
    border-radius: 8px;
    word-break: break-word;
    position: relative;
  }
  .closeBtn {
    position: absolute;
    top: 10px;
    right: 15px;
    background: red;
    color: white;
    padding: 0 10px;
    border-radius: 20px;
    cursor: pointer;
    font-weight: bold;
    user-select: none;
  }
  #wall {
    max-height: 400px;
    overflow-y: auto;
  }
  .headline-buttons {
    display: flex;
    flex-wrap: nowrap;
    overflow-x: auto;
    gap: 0.5em;
    justify-content: flex-start;
    margin-bottom: 1em;
    padding-bottom: 0.5em;
  }
  .headline-buttons button {
    background: var(--accent);
    border: none;
    padding: 0.4em 1em;
    color: white;
    border-radius: 20px;
    font-weight: bold;
    cursor: pointer;
    white-space: nowrap;
    flex-shrink: 0;
    width:auto;
  }
</style>
</head>
<body>
<header>üè¢ Smart Society Management System</header>

<div class="section" id="loginPage">
  <h2>Login</h2>
  <select id="role">
    <option value="admin">Admin</option>
    <option value="manager">Manager</option>
    <option value="watchman">Watchman</option>
    <option value="family">Family</option>
  </select>
  <input type="text" id="username" placeholder="Email" />
  <input type="password" id="password" placeholder="Password" />
  <button id="loginBtn">Login</button>
</div>

<div class="section hide" id="mainApp">
  <div id="userPanel"></div>

  <div id="adminPanel" class="hide">
    <h3>Add Event / Problem / Message</h3>
    <select id="adminCategory">
      <option>Meeting</option>
      <option>Party</option>
      <option>Children Program</option>
      <option>Problem</option>
      <option>Retirement Event</option>
      <option>Birthday</option>
      <option>Parking Issue</option>
    </select>
    <input id="eventTitle" placeholder="Title or Person Name" />
    <textarea id="eventDesc" placeholder="Description, timing, who arranged, etc..."></textarea>
    <button id="postCardBtn">Add to Society Wall</button>

    <div class="card" id="addMemberCard" style="margin-top: 2em;">
      <h4>Add New Society Member</h4>
      <input id="memberName" placeholder="Full Name" />
      <input id="memberHome" placeholder="Home No" />
      <select id="memberStatus">
        <option>Owner</option>
        <option>Rent</option>
        <option>Student</option>
        <option>Family</option>
      </select>
      <button id="addMemberBtn">Add Member</button>
    </div>
  </div>

  <div class="section">
    <div class="headline-buttons">
      <button data-filter="All">All</button>
      <button data-filter="Meeting">Meeting</button>
      <button data-filter="Party">Party</button>
      <button data-filter="Children Program">Children</button>
      <button data-filter="Problem">Problems</button>
      <button data-filter="Retirement Event">Retirement</button>
      <button data-filter="Birthday">Birthday</button>
      <button data-filter="Parking Issue">Parking</button>
      <button data-filter="New Member">New Member</button>
    </div>
    <h3>üìã Society Wall</h3>
    <div id="wall"></div>
  </div>

  <button id="logoutBtn">üö™ Logout</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAKc7A5wrLxPKUxgOO6V6KrJr-8eOVFal4",
    authDomain: "societymanagement-720f0.firebaseapp.com",
    projectId: "societymanagement-720f0",
    storageBucket: "societymanagement-720f0.firebasestorage.app",
    messagingSenderId: "746903378169",
    appId: "1:746903378169:web:aba39a80e787ee777f6a28",
    measurementId: "G-4FXH8NG8CT"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const users = {
    admin: { email: "admin@society.com", pass: "admin123" },
    manager: { email: "manager@society.com", pass: "manager123" },
    watchman: { email: "watchman@society.com", pass: "watch123" },
    family: { email: "family@society.com", pass: "family123" }
  };

  let currentRole = '';
  let selectedFilter = 'All';

  const loginPage = document.getElementById('loginPage');
  const mainApp = document.getElementById('mainApp');
  const userPanel = document.getElementById('userPanel');
  const adminPanel = document.getElementById('adminPanel');
  const wall = document.getElementById('wall');

  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const postCardBtn = document.getElementById('postCardBtn');
  const addMemberBtn = document.getElementById('addMemberBtn');
  const categorySelect = document.getElementById('adminCategory');
  const eventTitle = document.getElementById('eventTitle');
  const eventDesc = document.getElementById('eventDesc');
  const memberName = document.getElementById('memberName');
  const memberHome = document.getElementById('memberHome');
  const memberStatus = document.getElementById('memberStatus');
  const filterButtons = document.querySelectorAll('.headline-buttons button');

  loginBtn.onclick = () => {
    const email = document.getElementById('username').value.trim().toLowerCase();
    const pass = document.getElementById('password').value.trim();
    const role = document.getElementById('role').value;

    if(email === users[role].email && pass === users[role].pass) {
      currentRole = role;
      loginPage.classList.add('hide');
      mainApp.classList.remove('hide');
      userPanel.innerHTML = `üë§ Logged in as <b>${role.toUpperCase()}</b>`;
      if(role === 'admin') {
        adminPanel.classList.remove('hide');
      } else {
        adminPanel.classList.add('hide');
      }
      loadWall();
    } else {
      alert('‚ùå Invalid login! Please check email and password.');
    }
  };

  logoutBtn.onclick = () => {
    currentRole = '';
    loginPage.classList.remove('hide');
    mainApp.classList.add('hide');
    userPanel.innerHTML = '';
    wall.innerHTML = '';
    if(window.unsubscribe) window.unsubscribe();
  };

  postCardBtn.onclick = async () => {
    const cat = categorySelect.value;
    const title = eventTitle.value.trim();
    const desc = eventDesc.value.trim();

    if(!title || !desc) {
      alert('Please fill in title and description.');
      return;
    }

    const card = {
      category: cat,
      title,
      desc,
      date: Date.now()
    };

    try {
      await addDoc(collection(db, 'societyCards'), card);
      eventTitle.value = '';
      eventDesc.value = '';
    } catch(err) {
      alert('Error adding card: ' + err.message);
    }
  };

  addMemberBtn.onclick = async () => {
    const name = memberName.value.trim();
    const home = memberHome.value.trim();
    const status = memberStatus.value;

    if(!name || !home) {
      alert('Please enter both name and home no.');
      return;
    }

    const memberCard = {
      category: 'New Member',
      title: name,
      desc: `Home No: ${home}, Status: ${status}`,
      date: Date.now()
    };

    try {
      await addDoc(collection(db, 'societyCards'), memberCard);
      memberName.value = '';
      memberHome.value = '';
      alert(`‚úÖ Member ${name} added!`);
    } catch(err) {
      alert('Error adding member: ' + err.message);
    }
  };

  function loadWall() {
    let q = query(collection(db, 'societyCards'), orderBy('date', 'desc'));

    if(window.unsubscribe) window.unsubscribe();

    window.unsubscribe = onSnapshot(q, (snapshot) => {
      wall.innerHTML = '';

      snapshot.forEach(docSnap => {
        const c = docSnap.data();
        const id = docSnap.id;

        if(selectedFilter === 'All' || c.category === selectedFilter) {
          const colorClass = {
            'Meeting': '--meeting',
            'Party': '--party',
            'Children Program': '--children',
            'Problem': '--problem',
            'Retirement Event': '--retirement',
            'Birthday': '--birthday',
            'Parking Issue': '--parking',
            'New Member': '--bg'
          }[c.category] || '--bg';

          const div = document.createElement('div');
          div.className = 'card';
          div.style.backgroundColor = `var(${colorClass})`;

          if(currentRole === 'admin') {
            const delBtn = document.createElement('span');
            delBtn.className = 'closeBtn';
            delBtn.textContent = '√ó';
            delBtn.title = 'Delete card';
            delBtn.onclick = async () => {
              if(confirm('Are you sure to delete this card?')) {
                try {
                  await deleteDoc(doc(db, 'societyCards', id));
                } catch(err) {
                  alert('Error deleting card: ' + err.message);
                }
              }
            };
            div.appendChild(delBtn);
          }

          div.innerHTML += `<b>${c.category}:</b> ${c.title}<br>${c.desc}<br><small>${new Date(c.date).toLocaleString()}</small>`;

          wall.appendChild(div);
        }
      });
    });
  }

  filterButtons.forEach(btn => {
    btn.onclick = () => {
      selectedFilter = btn.getAttribute('data-filter');
      loadWall();
    };
  });

</script>

</body>
</html>
